<!DOCTYPE html>
<html lang="fa" dir="rtl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>صفحه معاملات - کارگزاری بانک تجارت</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/LOGO.svg}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #005A9C; --secondary-blue: #007BFF; --buy-green: #28a745; --sell-red: #dc3545;
            --background-light: #f8f9fa; --card-bg: #ffffff; --text-dark: #212529; --text-light: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.08); --border-color: #dee2e6; --font-family: 'Vazirmatn', sans-serif;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--background-light); color: var(--text-dark); line-height: 1.6; }
        header { background-color: var(--card-bg); padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px var(--shadow-color); position: sticky; top: 0; z-index: 1000; animation: fadeIn 0.7s ease-out; }
        .logo-container img { height: 45px; }
        nav { display: flex; align-items: center; gap: 1.5rem; }
        nav .user-info { font-weight: 600; color: var(--primary-blue); }
        nav button { background: transparent; color: var(--text-dark); border: none; padding: 10px 20px; cursor: pointer; border-radius: 50px; font-size: 14px; font-weight: 600; font-family: var(--font-family); transition: all 0.3s ease; }
        nav button.logout { border: 2px solid #ced4da; color: #6c757d; }
        nav button.logout:hover { background-color: var(--sell-red); border-color: var(--sell-red); color: var(--text-light); }
        nav form { display: inline; }
        main { padding: 2.5rem; max-width: 1400px; margin: auto; display: grid; grid-template-columns: 1fr; gap: 2.5rem; align-items: flex-start; }
        @media (min-width: 992px) { main { grid-template-columns: 1fr 2fr; } }
        .tables-container { display: flex; flex-direction: column; gap: 2.5rem; }
        .card { background-color: var(--card-bg); padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px var(--shadow-color); animation: slideUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .card h2 { color: var(--primary-blue); margin-bottom: 1.5rem; font-size: 1.6rem; }
        .form-group { margin-bottom: 1.2rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input { width: 100%; padding: 0.75rem; font-size: 1rem; font-family: var(--font-family); border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.3s ease; }
        .form-group input[readonly] { background-color: #e9ecef; cursor: not-allowed; }
        .form-group input:focus { outline: none; border-color: var(--secondary-blue); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2); }
        .order-type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.2rem; }
        .order-type-selector button { padding: 0.8rem; font-size: 1rem; font-weight: 700; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.3s ease; }
        .order-type-selector button.buy { background-color: #e9f5ec; color: var(--buy-green); }
        .order-type-selector button.sell { background-color: #fbebed; color: var(--sell-red); }
        .order-type-selector button.active { border-color: currentColor; }
        .submit-btn { width: 100%; padding: 0.9rem; font-size: 1.1rem; font-weight: 700; color: var(--text-light); border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
        .submit-btn.buy { background-color: var(--buy-green); }
        .submit-btn.sell { background-color: var(--sell-red); }
        .submit-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: right; }
        th, td { padding: 1rem 0.8rem; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { font-weight: 600; font-size: 0.9rem; color: #495057; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f1f3f5; }
        td.price-cell { transition: background-color 0.4s ease; }
        td.price-up { background-color: #e9f5ec !important; }
        td.price-down { background-color: #fbebed !important; }
        .status { padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; display: inline-block; }
        .status-completed { background-color: #e9f5ec; color: var(--buy-green); }
        .status-pending { background-color: #fff4e6; color: #ff9f43; }
        .status-failed { background-color: #fbebed; color: var(--sell-red); }
        .status-cancelled { background-color: #fbebed; color: var(--sell-red); }
        .order-type-buy { color: var(--buy-green); font-weight: 600; }
        .order-type-sell { color: var(--sell-red); font-weight: 600; }
        .select-symbol-btn { background-color: var(--secondary-blue); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8rem; font-family: var(--font-family); transition: background-color 0.2s; }
        .select-symbol-btn:hover { background-color: var(--primary-blue); }
        @media (max-width: 576px) {
            header { flex-direction: column; gap: 1rem; padding: 1rem; }
            main { padding: 1.5rem; } .card { padding: 1.5rem; } h2 { font-size: 1.4rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="logo-container">
        <a href="/"><img th:src="@{/TBRK_Logo.png}" alt="لوگوی تجارت"></a>
    </div>
    <nav>
        <div sec:authorize="!isAuthenticated()">
            <a href="/login"><button>ورود</button></a>
            <a href="/register"><button>ثبت‌نام</button></a>
        </div>
        <div sec:authorize="isAuthenticated()">
            <span class="user-info">کاربر: <span sec:authentication="name"></span></span>
            <a href="/order"><button>صفحه معاملات</button></a>
            <a href="/portfolio"><button>سبد دارایی</button></a>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="logout">خروج</button>
            </form>
        </div>
    </nav>
</header>

<main>
    <div class="card order-form-card" id="orderFormCard">
        <h2>ثبت سفارش جدید</h2>
        <form onsubmit="return false;">
            <input type="hidden" id="orderType" name="orderType" value="buy">
            <div class="order-type-selector">
                <button type="button" class="buy active" onclick="setOrderType('buy')">خرید</button>
                <button type="button" class="sell" onclick="setOrderType('sell')">فروش</button>
            </div>
            <div class="form-group">
                <label for="symbol">نماد</label>
                <input type="text" id="symbol" name="symbol" placeholder="نماد را از لیست انتخاب کنید" readonly>
            </div>
            <div class="form-group">
                <label for="quantity">تعداد</label>
                <input type="number" id="quantity" name="quantity" placeholder="تعداد سهم" oninput="calculateTotal()">
            </div>
            <div class="form-group">
                <label for="unit_price">قیمت واحد (ریال)</label>
                <input type="text" id="unit_price" name="unit_price" readonly placeholder="قیمت با انتخاب نماد ثبت می‌شود">
            </div>
            <div class="form-group">
                <label for="total_price">قیمت کل (ریال)</label>
                <input type="text" id="total_price" name="total_price" readonly>
            </div>
            <button type="button" class="submit-btn buy" id="submitBtn" onclick="submitOrder()">ثبت خرید</button>
        </form>
    </div>

    <div class="tables-container">
        <div class="card" id="symbolsListCard">
            <h2>لیست نمادها</h2>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>نماد</th>
                        <th>نام شرکت</th>
                        <th>قیمت</th>
                        <th>حجم معاملات</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody id="symbols-tbody">
                    <tr th:each="symbol : ${symbols}" th:id="'symbol-' + ${symbol.symbolId()}">
                        <td th:text="${symbol.symbolCode()}"></td>
                        <td th:text="${symbol.companyName()}"></td>
                        <td class="price-cell" th:text="${#numbers.formatDecimal(symbol.unitPrice(), 0, 'COMMA', 0, 'POINT')}"></td>
                        <td class="volume-cell" th:text="${#numbers.formatDecimal(symbol.tradingVolume(), 0, 'COMMA', 0, 'POINT')}"></td>
                        <td>
                            <button class="select-symbol-btn"
                                    th:data-symbol-code="${symbol.symbolCode()}"
                                    th:data-unit-price="${symbol.unitPrice()}"
                                    onclick="selectSymbol(this)">
                                انتخاب
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card" id="ordersTableCard">
            <h2>لیست سفارشات</h2>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th>نماد</th>
                        <th>نوع</th>
                        <th>تعداد</th>
                        <th>قیمت کل</th>
                        <th>تاریخ</th>
                        <th>وضعیت</th>
                    </tr>
                    </thead>
                    <tbody id="orders-tbody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    'use strict';
    let stompClient = null;

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/symbols', (symbolUpdate) => updateSymbolInTable(JSON.parse(symbolUpdate.body)));
            stompClient.subscribe('/topic/new-symbol', (newSymbol) => addSymbolToTable(JSON.parse(newSymbol.body)));
            stompClient.subscribe('/topic/new-order', (newOrder) => addOrderToTable(JSON.parse(newOrder.body), true));
            stompClient.subscribe('/topic/order-update', (updatedOrder) => updateOrderStatusInTable(JSON.parse(updatedOrder.body)));
        });
    }

    function formatPrice(price) {
        if (price === null || price === undefined) return '';
        return new Intl.NumberFormat('fa-IR').format(price);
    }

    function addSymbolToTable(symbol) {
        const tbody = document.getElementById('symbols-tbody');
        if (!document.getElementById(`symbol-${symbol.symbolId}`)) {
            const tr = document.createElement('tr');
            tr.id = `symbol-${symbol.symbolId}`;
            tr.innerHTML = `
                <td>${symbol.symbolCode}</td>
                <td>${symbol.companyName}</td>
                <td class="price-cell">${formatPrice(symbol.unitPrice)}</td>
                <td class="volume-cell">${formatPrice(symbol.tradingVolume)}</td>
                <td>
                    <button class="select-symbol-btn"
                            data-symbol-code="${symbol.symbolCode}"
                            data-unit-price="${symbol.unitPrice}"
                            onclick="selectSymbol(this)">
                        انتخاب
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        }
    }

    function updateSymbolInTable(symbol) {
        const row = document.getElementById(`symbol-${symbol.symbolId}`);
        if (row) {
            const priceCell = row.cells[2];
            const volumeCell = row.cells[3];
            const oldPrice = parseFloat(priceCell.textContent.replace(/,/g, '')) || 0;

            priceCell.textContent = formatPrice(symbol.unitPrice);
            volumeCell.textContent = formatPrice(symbol.tradingVolume);

            priceCell.classList.remove('price-up', 'price-down');
            if (symbol.unitPrice > oldPrice) priceCell.classList.add('price-up');
            else if (symbol.unitPrice < oldPrice) priceCell.classList.add('price-down');
            setTimeout(() => priceCell.classList.remove('price-up', 'price-down'), 1000);

            const selectBtn = row.querySelector('.select-symbol-btn');
            if(selectBtn) {
                selectBtn.dataset.symbolCode = symbol.symbolCode;
                selectBtn.dataset.unitPrice = symbol.unitPrice;
            }
        }
    }

    async function loadMyOrders() {
        try {
            const response = await fetch('/api/orders');
            if (!response.ok) throw new Error('Failed to fetch orders');
            const orders = await response.json();
            const tbody = document.getElementById('orders-tbody');
            tbody.innerHTML = '';
            orders.forEach(order => addOrderToTable(order, false));
        } catch (error) {
            console.error('Error loading orders:', error);
        }
    }

    function addOrderToTable(order, prepend) {
        const tbody = document.getElementById('orders-tbody');
        const tr = document.createElement('tr');
        tr.id = `order-${order.orderId}`;
        const orderDate = new Date(order.orderDate).toLocaleDateString('fa-IR', {
            hour: '2-digit', minute: '2-digit'
        });

        tr.innerHTML = `
            <td>${order.symbolCode}</td>
            <td class="order-type-${order.orderType}">${order.orderType === 'buy' ? 'خرید' : 'فروش'}</td>
            <td>${formatPrice(order.quantity)}</td>
            <td>${formatPrice(order.totalPrice)}</td>
            <td>${orderDate}</td>
            <td class="status-cell"><span class="status status-${order.status}">${order.status}</span></td>
        `;

        if (prepend) {
            tbody.prepend(tr);
        } else {
            tbody.appendChild(tr);
        }
    }

    function updateOrderStatusInTable(order) {
        const row = document.getElementById(`order-${order.orderId}`);
        if (row) {
            const statusCell = row.querySelector('.status-cell');
            if (statusCell) {
                statusCell.innerHTML = `<span class="status status-${order.status}">${order.status}</span>`;
            }
        }
    }

    const orderFormCard = document.getElementById('orderFormCard');
    const symbolInput = document.getElementById('symbol');
    const unitPriceInput = document.getElementById('unit_price');
    const quantityInput = document.getElementById('quantity');
    const totalPriceInput = document.getElementById('total_price');
    const orderTypeInput = document.getElementById('orderType');
    const submitButton = document.getElementById('submitBtn');

    // =========== این تابع اصلاح شد ===========
    function selectSymbol(buttonElement) {
        const symbolName = buttonElement.dataset.symbolCode;
        const unitPrice = buttonElement.dataset.unitPrice;

        symbolInput.value = symbolName;
        unitPriceInput.value = formatPrice(unitPrice);
        unitPriceInput.dataset.rawPrice = unitPrice;
        calculateTotal();
        quantityInput.focus();
        orderFormCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function calculateTotal() {
        const quantity = parseFloat(quantityInput.value) || 0;
        const rawUnitPrice = parseFloat(unitPriceInput.dataset.rawPrice) || 0;
        const total = quantity * rawUnitPrice;
        totalPriceInput.value = total > 0 ? formatPrice(total) : '';
    }

    function setOrderType(type) {
        orderTypeInput.value = type;
        const buyButton = document.querySelector('.order-type-selector .buy');
        const sellButton = document.querySelector('.order-type-selector .sell');
        if (type === 'buy') {
            buyButton.classList.add('active');
            sellButton.classList.remove('active');
            submitButton.className = 'submit-btn buy';
            submitButton.innerText = 'ثبت خرید';
        } else {
            sellButton.classList.add('active');
            buyButton.classList.remove('active');
            submitButton.className = 'submit-btn sell';
            submitButton.innerText = 'ثبت فروش';
        }
    }

    async function submitOrder() {
        const orderRequest = {
            symbolCode: symbolInput.value,
            orderType: orderTypeInput.value,
            quantity: parseFloat(quantityInput.value)
        };

        if (!orderRequest.symbolCode || !orderRequest.quantity || orderRequest.quantity <= 0) {
            alert("لطفا نماد و تعداد را به درستی وارد کنید.");
            return;
        }

        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

        const headers = {
            'Content-Type': 'application/json',
            [csrfHeader]: csrfToken
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(orderRequest)
            });

            const resultText = await response.text();
            if (!response.ok) {
                try {
                    const errorData = JSON.parse(resultText);
                    throw new Error(errorData.message || `خطای سرور: ${response.status}`);
                } catch(e) {
                     throw new Error(resultText || `خطای سرور: ${response.status}`);
                }
            }

            console.log('سفارش با موفقیت ثبت شد');

            symbolInput.value = '';
            quantityInput.value = '';
            unitPriceInput.value = '';
            totalPriceInput.value = '';
            unitPriceInput.dataset.rawPrice = '0';

        } catch (error) {
            console.error('خطا در ثبت سفارش:', error);
            alert(error.message);
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        connect();
        loadMyOrders();
    });

</script>

</body>
</html>